## 推金币手机端

------

**用户**：

+ 进入活动页面

  + 根据`openid`初始化用户的活动记录并返回活动记录

    + 初始化用户剩余金币数目
    + 初始化礼物位置
    + 初始化道具
    + 初始化好友助力榜单

    ​

+ 点击放金币按钮（前端视觉金币下落）

  + 更新用户金币剩余数量（可能失败）
  + 更新礼物位置
    + 不动
    + 向前（距离根据算法决定）
  + 判断礼物盒是否掉落
    + 掉落
      + 判断是否有奖品
        + 没有奖品，判断用户是否**充钱**
          + **有充钱金额未失效** ，根据**未失效充值金额**按比例返回红包，标记**未失效充值金额**为失效状态
          + 未充钱，返回安慰信息
          + **有充钱金额未失效** ，返回安慰信息
        + 有奖品，***逻辑待商量***
    + 未掉落



+ 点击活动规则
  + 查询奖品信息与获奖信息
+ ​





丢金币执行细节：

+ 加锁读取 UserPlayInfo 扩展字段的用户当前金币剩余量


+ 判断金币足够扣除（）
  + 不够扣除
    + 返回金币不足错误信息
  + 足够扣除
    + 更新 UserPlayInfo 扩展字段的用户当前金币剩余量
    + 更新 UserPlayInfo 扩展字段的已为奖品花费的金币数
    + 将更新后的 UserPlayInfo 写回缓存
    + 向客户端返回提示信息并同步用户金币剩余量





使用道具执行细节：

+ 加锁读取 UserPlayInfo 扩展字段的道具剩余数量
+ 判断是否还有道具
  + 没有道具
  + 道具足够
    + 扣除道具数量
    + 更新 UserPlayInfo 扩展字段的已为奖品花费的金币数
    + 将更新后的 UserPlayInfo 写回缓存
+ ​